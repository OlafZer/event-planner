{% extends 'base.html' %}
{% block content %}
<h2>Admin Übersicht</h2>

{% if current_user.is_super_admin %}
<div class="card mb-4">
    <div class="card-body">
        <h4 class="card-title">Neues Event anlegen</h4>
        <form method="post">
            {{ event_form.hidden_tag() }}
            <div class="mb-3">
                {{ event_form.name.label(class_='form-label') }}
                {{ event_form.name(class_='form-control') }}
            </div>
            <div class="mb-3">
                {{ event_form.code_prefix.label(class_='form-label') }}
                {{ event_form.code_prefix(class_='form-control') }}
                <div class="form-text">Zweibuchstabiger Prefix für Einladungscodes, z. B. "SF".</div>
            </div>
            <div class="mb-3">
                {{ event_form.description.label(class_='form-label') }}
                {{ event_form.description(class_='form-control') }}
            </div>
            <div class="mb-3">
                {{ event_form.event_date.label(class_='form-label') }}
                {{ event_form.event_date(class_='form-control') }}
            </div>
            <div class="mb-3">
                {{ event_form.invitation_text.label(class_='form-label') }}
                {{ event_form.invitation_text(class_='form-control', rows='4') }}
            </div>
            <div class="mb-3">
                {{ event_form.background_image_url.label(class_='form-label') }}
                {{ event_form.background_image_url(class_='form-control') }}
                <div class="form-text">Optionales Hintergrundbild, z. B. ein Unsplash-Link.</div>
            </div>
            {{ event_form.submit_event(class_='btn btn-primary') }}
        </form>
    </div>
</div>
{% endif %}

<div class="card mb-4">
    <div class="card-body">
        <h4 class="card-title">Event-Auswahl</h4>
        {% if available_events %}
        <form method="get" class="row g-3 align-items-center">
            <div class="col-auto">
                <label class="col-form-label" for="event_id">Event</label>
            </div>
            <div class="col-auto">
                <select class="form-select" id="event_id" name="event_id">
                    {% for event in available_events %}
                    <option value="{{ event.id }}" {% if active_event and active_event.id == event.id %}selected{% endif %}>{{ event.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <button class="btn btn-secondary" type="submit">Anzeigen</button>
            </div>
        </form>
        {% else %}
        <p class="mb-0">Noch keine Events vorhanden. Bitte als Super-Admin eines erstellen.</p>
        {% endif %}
    </div>
</div>

{% if active_event %}
  <div class="mb-3">
      <h4 class="mb-0">{{ active_event.name }}</h4>
      <div class="text-muted">Prefix: {{ active_event.code_prefix }}</div>
  </div>
  <div class="row row-cols-1 row-cols-md-4 g-3 mb-4">
      <div class="col">
          <div class="card text-bg-primary">
              <div class="card-body">
                  <h6 class="text-uppercase">Gäste gesamt</h6>
                  <p class="fs-4 mb-0">{{ stats.total }}</p>
              </div>
          </div>
      </div>
      <div class="col">
          <div class="card text-bg-success">
              <div class="card-body">
                  <h6 class="text-uppercase">Zusagen (Pax)</h6>
                  <p class="fs-4 mb-0">{{ stats.pax_yes }}</p>
              </div>
          </div>
      </div>
      <div class="col">
          <div class="card text-bg-danger">
              <div class="card-body">
                  <h6 class="text-uppercase">Absagen</h6>
                  <p class="fs-4 mb-0">{{ stats.declined }}</p>
              </div>
          </div>
      </div>
      <div class="col">
          <div class="card text-bg-warning">
              <div class="card-body">
                  <h6 class="text-uppercase">Ausstehend</h6>
                  <p class="fs-4 mb-0">{{ stats.open }}</p>
              </div>
          </div>
      </div>
  </div>
  <div class="mb-4">
      <h4>CSV Import für {{ active_event.name }}</h4>
      <form method="post" enctype="multipart/form-data">
          {{ upload_form.hidden_tag() }}
          {{ upload_form.event_id(value=active_event.id, type='hidden') }}
        <div class="mb-3">
            {{ upload_form.file.label(class_='form-label') }}
            {{ upload_form.file(class_='form-control') }}
        </div>
          {{ upload_form.submit(class_='btn btn-success') }}
          <a class="btn btn-link" href="{{ url_for('admin.download_template', event_id=active_event.id) }}">CSV Template herunterladen</a>
      </form>
  </div>
  <div class="card mb-4">
      <div class="card-body">
          <h4 class="card-title">Gast manuell anlegen</h4>
          <form method="post">
              {{ guest_form.hidden_tag() }}
              <div class="row g-3">
                  <div class="col-md-6">
                      {{ guest_form.first_name.label(class_='form-label') }}
                      {{ guest_form.first_name(class_='form-control') }}
                  </div>
                  <div class="col-md-6">
                      {{ guest_form.last_name.label(class_='form-label') }}
                      {{ guest_form.last_name(class_='form-control') }}
                  </div>
                  <div class="col-md-6">
                      {{ guest_form.category.label(class_='form-label') }}
                      {{ guest_form.category(class_='form-select') }}
                  </div>
                  <div class="col-md-6">
                      {{ guest_form.max_persons.label(class_='form-label') }}
                      {{ guest_form.max_persons(class_='form-control') }}
                  </div>
                  <div class="col-md-6">
                      {{ guest_form.invite_code.label(class_='form-label') }}
                      <div class="input-group">
                          <span class="input-group-text">{{ active_event.code_prefix }}</span>
                          {{ guest_form.invite_code(class_='form-control') }}
                      </div>
                  </div>
                  <div class="col-md-6">
                      {{ guest_form.email.label(class_='form-label') }}
                      {{ guest_form.email(class_='form-control') }}
                      <div class="form-text">E-Mail ist optional.</div>
                  </div>
                  <div class="col-md-6">
                      {{ guest_form.telephone.label(class_='form-label') }}
                      {{ guest_form.telephone(class_='form-control') }}
                  </div>
                  <div class="col-md-6 form-check mt-4">
                      {{ guest_form.notify_admin(class_='form-check-input') }}
                      {{ guest_form.notify_admin.label(class_='form-check-label') }}
                  </div>
              </div>
              <div class="mt-3">
                  {{ guest_form.submit_guest(class_='btn btn-primary') }}
              </div>
          </form>
      </div>
  </div>
  {% set status_labels = {
    "save_the_date": "Save the Date",
    "zusage": "Zusage",
    "absage": "Absage",
    "unsicher": "Unsicher"
  } %}
  {% set status_classes = {
    "save_the_date": "primary",
    "zusage": "success",
    "absage": "danger",
    "unsicher": "warning"
  } %}
  <table class="table table-striped align-middle">
      <thead>
          <tr>
              <th>Vorname</th>
              <th>Nachname</th>
              <th>Kategorie</th>
              <th>Max Personen</th>
              <th>Pers. (Bestätigt)</th>
              <th>Status</th>
              <th>Besonderer Hinweis</th>
              <th>Email (optional)</th>
              <th>Telefon</th>
              <th>Benachrichtigung</th>
              <th class="text-end">Aktionen</th>
          </tr>
      </thead>
      <tbody>
          {% for guest in guests %}
          <tr>
              <td>{{ guest.first_name }}</td>
              <td>{{ guest.last_name or '' }}</td>
              <td>{{ guest.category }}</td>
              <td>{{ guest.max_persons }}</td>
              <td>{{ guest.confirmed_persons }}</td>
              <td>
                  <span class="badge text-bg-{{ status_classes.get(guest.status, 'secondary') }}">
                      {{ status_labels.get(guest.status, guest.status) }}
                  </span>
              </td>
              <td>{{ (guest.notes or '—') | e | replace('\n', '<br>') | safe }}</td>
              <td>{{ guest.email or '—' }}</td>
              <td>{{ guest.telephone or '—' }}</td>
              <td>{{ 'Ja' if guest.notify_admin else 'Nein' }}</td>
              <td class="text-end">
                  <div class="d-flex flex-column gap-2 align-items-end">
                      <button
                          type="button"
                          class="btn btn-sm btn-primary"
                          data-bs-toggle="modal"
                          data-bs-target="#editGuestModal-{{ guest.id }}"
                      >
                          Bearbeiten
                      </button>
                      {% if guest.email %}
                      <form method="post" action="{{ url_for('admin.send_guest_email', event_id=active_event.id, guest_id=guest.id) }}" class="w-100">
                          {{ action_form.csrf_token }}
                          <input type="hidden" name="guest_id" value="{{ guest.id }}">
                          <input type="hidden" name="action" value="email">
                          <button type="submit" class="btn btn-sm btn-outline-primary w-100">E-Mail senden</button>
                      </form>
                      {% endif %}
                      <button type="button" class="btn btn-sm btn-outline-secondary copy-text w-100" data-text="Hallo {{ guest.first_name }}, hier ist deine Einladung für {{ active_event.name }}: {{ url_for('public.invite', event_id=active_event.id, code=guest.invite_code_hash, _external=True) }}">
                        Text kopieren
                      </button>
                      <a class="btn btn-sm btn-outline-success w-100" href="{{ url_for('admin.download_guest_pdf', event_id=active_event.id, guest_id=guest.id) }}">PDF laden</a>
                  </div>
              </td>
          </tr>
          {% endfor %}
      </tbody>
  </table>
  {% for guest in guests %}
  {% set update_form = update_forms[guest.id] %}
  <div class="modal fade" id="editGuestModal-{{ guest.id }}" tabindex="-1" aria-labelledby="editGuestLabel-{{ guest.id }}" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="editGuestLabel-{{ guest.id }}">Gast bearbeiten: {{ guest.first_name }} {{ guest.last_name or '' }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
              </div>
              <form method="post" action="{{ url_for('admin.update_guest_status', event_id=active_event.id, guest_id=guest.id) }}">
                  {{ update_form.hidden_tag() }}
                  <div class="modal-body">
                      <div class="mb-3">
                          <label class="form-label" for="status-{{ guest.id }}">Status</label>
                          {{ update_form.status(class_='form-select', id='status-' ~ guest.id) }}
                      </div>
                      <div class="mb-3">
                          <label class="form-label" for="confirmed-{{ guest.id }}">Bestätigte Personen</label>
                          {{ update_form.confirmed_persons(
                              class_='form-control',
                              id='confirmed-' ~ guest.id,
                              type='number',
                              min=0,
                              max=guest.max_persons
                          ) }}
                          <div class="form-text">Max {{ guest.max_persons }}</div>
                      </div>
                      <p class="mb-0 text-muted small">Maximale Personen laut Einladung: {{ guest.max_persons }}</p>
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                      <button type="submit" class="btn btn-primary">Speichern</button>
                  </div>
              </form>
          </div>
      </div>
  </div>
  {% endfor %}
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.querySelectorAll('.copy-text').forEach((btn) => {
        btn.addEventListener('click', () => {
            const text = btn.getAttribute('data-text');
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Text kopiert';
                setTimeout(() => btn.textContent = 'Text kopieren', 2000);
            });
        });
    });
</script>
{% endblock %}
